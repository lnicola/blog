<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0,maximum-scale=1,viewport-fit=cover" name=viewport><title>About a fun little NFS bug</title><link href=/print.css media=print rel=stylesheet><link href=/poole.css rel=stylesheet><link href=/hyde.css rel=stylesheet><link href=https://blog.dend.ro/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://mapstodon.space/@lnicola rel=me><body><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.dend.ro/><h1></h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a><li class=sidebar-nav-item><a href=/content/talks/>Talks</a><li class=sidebar-nav-item><a href=/content/blogroll/>Blogroll</a><li class=sidebar-nav-item><a href=/content/acknowledgements/>Acknowledgements</a><li class=sidebar-nav-item><a href=https://www.buymeacoffee.com/lnicolaq>Buy me a ☕</a></ul></div></div><div class="content container"><div class=post><h1 class=post-title>About a fun little NFS bug</h1><span class=post-date>2022-06-29</span><p>One <a href=https://blog.dend.ro/a-mysterous-python-crash/>cloud provider</a> I sometimes work with has a large repository of images, accessible using the S3 protocol or over an NFS gateway. Today I spent a bit of time debugging an issue related to the NFS gateway, so read on for more — and for a twist at the end.<h2 id=something-is-broken>Something is broken</h2><p>I have a workload which involves relatively many of those images at once, accessed through the <a href=https://github.com/s3fs-fuse/s3fs-fuse><code>s3fs</code></a> FUSE helper (a way to make an S3 bucket look like a file system). For some reason, sometimes requests start failing after a while, and using NFS is a way to work around that.<p>But something strange was happening today when I was trying to use the NFS share. One version of <a href=https://github.com/OSGeo/gdal/>GDAL</a> was able to read the files, while another, older one, complained they were invalid and wasn't able to open them. Using <code>s3fs</code>, both GDAL versions worked fine.<p>This made me think that NFS is returning corrupted files (maybe with some junk at the end), and the newer GDAL was able to ignore that. But on a closer look, both <code>s3fs</code> and NFS returned identical (up to a checksum, at least) files. This was the cause of some head scratching, since reading a the same file from different places should yield the same results —<h2 id=my-favourite-tool>My favourite tool</h2><p>— unless maybe it shouldn't? This story seemed fishy and I broke out what's probably my favourite debugging tool, <code>strace</code>. <code>strace</code> sets breakpoints on every interaction of a program with the operating system (<a href=https://en.wikipedia.org/wiki/System_call>system call</a>) and displays the request involved, including the arguments. So, for example, if Linux a program tries to open a file, it will show up in <code>strace</code> as an <code>open</code> or <code>openat</code> call.<p><em>Note: if that sounds interesting and you want to know more, check out <a href=https://jvns.ca/blog/2015/04/14/strace-zine/>this zine</a> and <a href=https://jvns.ca/blog/2021/04/03/what-problems-do-people-solve-with-strace/>this article</a>. And if you're not using Linux, you can try <a href=https://docs.microsoft.com/en-us/sysinternals/downloads/procmon>Process Monitor</a> or <a href=http://dtrace.org/blogs/about/>DTrace</a>.</em><p>So I gave <code>strace</code> a try (edited for brevity):<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> strace gdalinfo /mount_nfs/path/to/file.jp2 </span><span style=color:#65737e># old GDAL
</span><span style=color:#bf616a>[snip]
</span><span style=color:#bf616a>stat</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>", {st_mode=S_IFREG|0666, st_size=115495922, ...}) = </span><span style=color:#bf616a>0
</span><span style=color:#bf616a>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>", O_RDONLY) = </span><span style=color:#bf616a>3
</span><span style=color:#bf616a>fstat</span><span>(3, {st_mode=S_IFREG|0666, st_size=115495922, ...}) = </span><span style=color:#bf616a>0
</span><span style=color:#bf616a>read</span><span>(3, "</span><span style=color:#a3be8c>[snip]</span><span>"..., 8192) = </span><span style=color:#bf616a>8192
</span><span style=color:#bf616a>lseek</span><span>(3, 0, SEEK_SET) = </span><span style=color:#bf616a>0
</span><span style=color:#bf616a>[snip]
</span><span style=color:#bf616a>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>", O_RDONLY) = </span><span style=color:#bf616a>-1</span><span> EPERM (Operation not permitted)
</span><span style=color:#bf616a>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>", O_RDONLY) = </span><span style=color:#bf616a>-1</span><span> EPERM (Operation not permitted)
</span><span style=color:#bf616a>[snip]
</span></code></pre><p>Most of the output above isn't too important, but the last <code>open</code> calls fail with <code>EPERM</code>, which sounds like a good reason to not work. If you have trouble reading the log, the full sequence is:<ul><li><code>gdalinfo</code> checks the file length and attributes<li><code>gdalinfo</code> opens the file<li><code>gdalinfo</code> checks the length and attributes of the open file<li><code>gdalinfo</code> reads 8 KB from the file, which works, then rewinds to the beginning<li><code>gdalinfo</code> tries to open the file again and gets a permissions-related error<li><code>gdalinfo</code> tries to open the file again and gets a permissions-related error</ul><p>Sure, this is a bit redundant, but it doesn't matter that much when you're reading 115 MB. Note how the first <code>open</code> call works, then but the next ones fail.<p>In contrast, the newer GDAL works because it only tries to open the file once. So what's wrong, can we only read files once?<p>Of course not, otherwise a second <code>gdalinfo</code> wouldn't work. So a better theory is that we can't open the same file twice. And now that we have a theory, we can try to confirm it using <del>Rust</del> just kidding, let's use Python this time:<pre class=language-python data-lang=python style=color:#c0c5ce;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#65737e># open the file once, works
</span><span>>>> f1 = </span><span style=color:#96b5b4>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>")
</span><span>
</span><span style=color:#65737e># open it again, fails with EPERM
</span><span>>>> f2 = </span><span style=color:#96b5b4>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>")
</span><span style=color:#bf616a>Traceback </span><span>(most recent call last):
</span><span>  File "</span><span style=color:#a3be8c>&lt;stdin></span><span>", line </span><span style=color:#d08770>1</span><span>, in &lt;module>
</span><span>IOError: [Errno </span><span style=color:#d08770>1</span><span>] Operation not permitted: '</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>'
</span><span>
</span><span style=color:#65737e># close the first handle
</span><span>>>> f1.</span><span style=color:#bf616a>close</span><span>()
</span><span>
</span><span style=color:#65737e># opening it works
</span><span>>>> f2 = </span><span style=color:#96b5b4>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>")
</span><span>
</span><span style=color:#65737e># opening it a second time fails again
</span><span>>>> f3 = </span><span style=color:#96b5b4>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>")
</span><span style=color:#bf616a>Traceback </span><span>(most recent call last):
</span><span>  File "</span><span style=color:#a3be8c>&lt;stdin></span><span>", line </span><span style=color:#d08770>1</span><span>, in &lt;module>
</span><span>IOError: [Errno </span><span style=color:#d08770>1</span><span>] Operation not permitted: '</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>'
</span><span>
</span><span style=color:#65737e># and so on
</span><span>>>> f2.</span><span style=color:#bf616a>close</span><span>()
</span><span>>>> f3 = </span><span style=color:#96b5b4>open</span><span>("</span><span style=color:#a3be8c>/mount_nfs/path/to/file.jp2</span><span>")
</span><span>>>>
</span></code></pre><p>So yeah, our theory was correct. I don't know what kind of server we're dealing with, but it doesn't let us open any file multiple times. It even fails — maybe not surprisingly — if we're opening it from different processes.<p>I wasn't able to find any reports of a similar problem, so one of my reasons for writing this is to make it available to search engines.<h2 id=the-solution>The solution</h2><p>I also happened to stumble upon a pretty simple workaround: add <code>nfsvers=3</code> to the mount options (<code>/etc/fstab</code>). It appears that the problem only occurs when using NFSv4, and not NFSv3.<h2 id=a-final-twist>A final twist</h2><p>All this sounded somewhat familiar, so I searched through my inbox and found I had already reported this to the cloud provider in March 2020. I even took a <code>tcpdump</code> capture and found out that the server was returning <code>NFS4ERR_PERM</code> on the failing call:<blockquote><p>This indicates that the requester is not the owner. The operation was not allowed because the caller is neither a privileged user (root) nor the owner of the target of the operation.</blockquote><p>But don't confuse this with <code>NFS4ERR_ACCESS</code>:<blockquote><p>This indicates permission denied. The caller does not have the correct permission to perform the requested operation. Contrast this with NFS4ERR_PERM (Section 13.1.6.2), which restricts itself to owner or privileged user permission failures.</blockquote><p>Hear this, Google? If you've got a weird NFS server that doesn't allow you to open files a second time and yields <code>NFS4ERR_PERM</code>, try downgrading to NFSv3.<p>And no, the provider never answered back.<hr><p>By the way, if your files sometime go away or can't be reopened, please consider <a href=https://www.buymeacoffee.com/lnicolaq>buying me a coffee</a>.</div></div>