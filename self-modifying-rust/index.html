<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0,maximum-scale=1,viewport-fit=cover" name=viewport><title>On self-modifying executables in Rust</title><link href=/print.css media=print rel=stylesheet><link href=/poole.css rel=stylesheet><link href=/hyde.css rel=stylesheet><link href=https://blog.dend.ro/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://mapstodon.space/@lnicola rel=me><body><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://blog.dend.ro/><h1></h1></a></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a><li class=sidebar-nav-item><a href=/content/talks/>Talks</a><li class=sidebar-nav-item><a href=/content/blogroll/>Blogroll</a><li class=sidebar-nav-item><a href=/content/acknowledgements/>Acknowledgements</a><li class=sidebar-nav-item><a href=https://www.buymeacoffee.com/lnicolaq>Buy me a ☕</a></ul></div></div><div class="content container"><div class=post><h1 class=post-title>On self-modifying executables in Rust</h1><span class=post-date>2022-01-23</span><p>This is a short post prompted by a question on <a href=https://reddit.com/r/rust/>/r/rust</a> from May 2019, asking about a way for a Rust program to modify itself.<p>Think of how much fun it would be to store a high score list directly inside the a executable. When you make a copy (on floppy disk, to make things more realistic) and pass it to your friends, your high scores are persisted.<h2 id=errata>Errata</h2><ul><li>the variable should probably be marked as <code>#[repr(C)]</code>.<li>as <a href=https://www.reddit.com/r/rust/comments/saxzs8/on_selfmodifying_executables_in_rust/htwxint/>pointed out</a> by a reader, <code>unsafe { ptr::read_volatile(&RUN_COUNT) }</code> is a better alternative to <code>static mut</code>.<li>you probably shouldn't do this except as a party trick.</ul><h2 id=diving-right-in>Diving right in</h2><p>As a proof of concept, we'll write a program that counts how many times it has been run. This is hardly the only approach, but probably the simplest way is to store the counter in a separate section of the executable.<pre class=language-rust data-lang=rust style=color:#c0c5ce;background-color:#2b303b><code class=language-rust data-lang=rust><span>#[</span><span style=color:#bf616a>link_section </span><span>= "</span><span style=color:#a3be8c>count</span><span>"]
</span><span>#[</span><span style=color:#bf616a>used</span><span>]
</span><span style=color:#b48ead>static mut </span><span style=color:#d08770>RUN_COUNT</span><span>: </span><span style=color:#b48ead>u32 </span><span>= </span><span style=color:#d08770>0</span><span>;
</span></code></pre><p><code>#[link_section]</code> tells the linker to put the variable in a section called <code>count</code>. <a href=https://rust-lang.github.io/rfcs/2386-used.html><code>#[used]</code></a> means that the variable must be kept by the linker, even if could be optimized away. Similarly, <code>mut</code> is required because otherwise the compiler will propagate the variable value to the code that reads it.<p>I'm not sure if the combination above the best way to accomplish this, or if it's guaranteed to work. It was the only working method I found back then, and it still seems to be the case today.<p>Since the code is so short, I'll just paste the rest of it here:<pre class=language-rust data-lang=rust style=color:#c0c5ce;background-color:#2b303b><code class=language-rust data-lang=rust><span style=color:#b48ead>use </span><span>memmap2::MmapOptions;
</span><span style=color:#b48ead>use </span><span>object::{File, Object, ObjectSection};
</span><span style=color:#b48ead>use </span><span>std::env;
</span><span style=color:#b48ead>use </span><span>std::error::Error;
</span><span style=color:#b48ead>use </span><span>std::fs::{</span><span style=color:#bf616a>self</span><span>, OpenOptions};
</span><span>
</span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>get_section</span><span>(</span><span style=color:#bf616a>file</span><span>: &File, </span><span style=color:#bf616a>name</span><span>: &</span><span style=color:#b48ead>str</span><span>) -> Option&lt;(</span><span style=color:#b48ead>u64</span><span>, </span><span style=color:#b48ead>u64</span><span>)> {
</span><span>    </span><span style=color:#b48ead>for</span><span> section in file.</span><span style=color:#96b5b4>sections</span><span>() {
</span><span>        </span><span style=color:#b48ead>match</span><span> section.</span><span style=color:#96b5b4>name</span><span>() {
</span><span>            Ok(n) </span><span style=color:#b48ead>if</span><span> n == name => {
</span><span>                </span><span style=color:#b48ead>return</span><span> section.</span><span style=color:#96b5b4>file_range</span><span>();
</span><span>            }
</span><span>            _ => {}
</span><span>        }
</span><span>    }
</span><span>    None
</span><span>}
</span><span>
</span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>main</span><span>() -> Result&lt;(), Box&lt;dyn Error>> {
</span><span>    </span><span style=color:#b48ead>let</span><span> run_count = </span><span style=color:#b48ead>unsafe </span><span>{ </span><span style=color:#d08770>RUN_COUNT </span><span>};
</span><span>    println!("</span><span style=color:#a3be8c>Previous run count: </span><span style=color:#d08770>{}</span><span>", run_count);
</span><span>    </span><span style=color:#b48ead>let</span><span> exe = env::current_exe()?;
</span><span>    </span><span style=color:#b48ead>let</span><span> tmp = exe.</span><span style=color:#96b5b4>with_extension</span><span>("</span><span style=color:#a3be8c>tmp</span><span>");
</span><span>    fs::copy(&exe, &tmp)?;
</span><span>
</span><span>    </span><span style=color:#b48ead>let</span><span> file = OpenOptions::new().</span><span style=color:#96b5b4>read</span><span>(</span><span style=color:#d08770>true</span><span>).</span><span style=color:#96b5b4>write</span><span>(</span><span style=color:#d08770>true</span><span>).</span><span style=color:#96b5b4>open</span><span>(&tmp)?;
</span><span>    </span><span style=color:#b48ead>let mut</span><span> buf = </span><span style=color:#b48ead>unsafe </span><span>{ MmapOptions::new().</span><span style=color:#96b5b4>map_mut</span><span>(&file) }?;
</span><span>    </span><span style=color:#b48ead>let</span><span> file = File::parse(&*buf)?;
</span><span>
</span><span>    </span><span style=color:#b48ead>if let </span><span>Some(range) = </span><span style=color:#96b5b4>get_section</span><span>(&file, "</span><span style=color:#a3be8c>count</span><span>") {
</span><span>        assert_eq!(range.</span><span style=color:#d08770>1</span><span>, </span><span style=color:#d08770>4</span><span>);
</span><span>        </span><span style=color:#b48ead>let</span><span> base = range.</span><span style=color:#d08770>0 </span><span>as </span><span style=color:#b48ead>usize</span><span>;
</span><span>        buf[base..(base + </span><span style=color:#d08770>4</span><span>)].</span><span style=color:#96b5b4>copy_from_slice</span><span>(&(run_count + </span><span style=color:#d08770>1</span><span>).</span><span style=color:#96b5b4>to_ne_bytes</span><span>());
</span><span>
</span><span>        </span><span style=color:#b48ead>let</span><span> perms = fs::metadata(&exe)?.</span><span style=color:#96b5b4>permissions</span><span>();
</span><span>        fs::set_permissions(&tmp, perms)?;
</span><span>        fs::rename(&tmp, &exe)?;
</span><span>    } </span><span style=color:#b48ead>else </span><span>{
</span><span>        fs::remove_file(&tmp)?;
</span><span>    }
</span><span>
</span><span>    Ok(())
</span><span>}
</span></code></pre><p>We look up the current executable, and map it into memory using <a href=https://docs.rs/memmap2/><code>memmap2</code></a>. Then we get a list of sections using the <a href=https://docs.rs/object/><code>object</code></a> crate, search for one called <code>count</code> — beware of libraries using the same name! — then replace the variable value in the memory-mapped view of the file.<p>All this happens on a copy of our program. Self-modifying programs were fine under MS-DOS, but modern operating systems won't let it fly. Renaming or overwriting is fine, since the original file is still unchanged.<p>You can see a nice diagram showing the ELF (the executable format on my platform) structure <a href=https://github.com/corkami/pics/blob/28cb0226093ed57b348723bc473cea0162dad366/binary/elf101/elf101-64.svg>here</a>. But we're not here to learn about executable formats. We're here to clear out a tiny bit of backlog and see a working example, so does it work?<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> cargo run</span><span style=color:#bf616a> --release
</span><span>   </span><span style=color:#bf616a>Compiling</span><span> self-modify v0.1.0 (/home/grayshade/Projects/self-modify)
</span><span>    </span><span style=color:#bf616a>Finished</span><span> release </span><span style=color:#b48ead>[</span><span>optimized</span><span style=color:#b48ead>]</span><span> target(s) </span><span style=color:#bf616a>in</span><span> 0.30s
</span><span>     </span><span style=color:#bf616a>Running </span><span>`</span><span style=color:#bf616a>target/release/self-modify</span><span>`
</span><span style=color:#bf616a>Previous</span><span> run count: 0
</span><span style=color:#bf616a>$</span><span> target/release/self-modify
</span><span style=color:#bf616a>Previous</span><span> run count: 1
</span><span style=color:#bf616a>$</span><span> target/release/self-modify
</span><span style=color:#bf616a>Previous</span><span> run count: 2
</span><span style=color:#bf616a>$</span><span> target/release/self-modify
</span><span style=color:#bf616a>Previous</span><span> run count: 3
</span></code></pre><p>It does!<p>Note that I'm on Linux. The <code>object</code> crate should work with MacOS and Windows executables too, but on Windows the <code>fs::rename</code> call will probably fail. There you can rename the current executable to some temporary name, but I don't want to deal with that stuff <a href=https://github.com/rust-analyzer/rust-analyzer/issues/6602>again</a>.<h2 id=bonus-section>Bonus <em>section</em></h2><p>I mentioned above that declaring our variable as <code>mut</code> is necessary because the compiler will optimize it otherwise. How did I figure that out?<p>First, let's simplify the code and give the variable a more noticeable value:<pre class=language-rust data-lang=rust style=color:#c0c5ce;background-color:#2b303b><code class=language-rust data-lang=rust><span>#[</span><span style=color:#bf616a>link_section </span><span>= "</span><span style=color:#a3be8c>count</span><span>"]
</span><span>#[</span><span style=color:#bf616a>used</span><span>]
</span><span style=color:#b48ead>static mut </span><span style=color:#d08770>RUN_COUNT</span><span>: </span><span style=color:#b48ead>u32 </span><span>= </span><span style=color:#d08770>0x55aa55aa</span><span>;
</span><span>
</span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>main</span><span>() {
</span><span>    </span><span style=color:#b48ead>let</span><span> run_count = </span><span style=color:#b48ead>unsafe </span><span>{ </span><span style=color:#d08770>RUN_COUNT </span><span>};
</span><span>    println!("</span><span style=color:#a3be8c>Previous run count: </span><span style=color:#d08770>{}</span><span>", run_count);
</span><span>}
</span></code></pre><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> cargo build</span><span style=color:#bf616a> --release
</span><span style=color:#bf616a>$</span><span> objdump</span><span style=color:#bf616a> -d</span><span> target/release/self-modify
</span></code></pre><pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#96b5b4>[snip]
</span><span style=color:#d08770>0000000000011160 </span><span style=color:#8fa1b3>&lt;_ZN11self_modify4main17hd56d204cd8f62812E>:
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11160</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 83 </span><span style=color:#8fa1b3>ec </span><span style=color:#d08770>48             </span><span style=color:#b48ead>sub    </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x48</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rsp
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11164</span><span style=color:#8fa1b3>:       8b </span><span style=color:#d08770>05 </span><span style=color:#8fa1b3>ee 7e </span><span style=color:#d08770>03 00       </span><span style=color:#b48ead>mov    </span><span style=color:#d08770>0x37eee</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rip</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>eax        </span><span style=color:#8fa1b3># </span><span style=color:#d08770>49058 </span><span style=color:#8fa1b3>&lt;__TMC_END__>
</span><span style=color:#8fa1b3>   1116a:       </span><span style=color:#d08770>89 44 24 04             </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>eax</span><span>,</span><span style=color:#d08770>0x4</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   1116e:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d </span><span style=color:#d08770>44 24 04          </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x4</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11173</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 89 44 24 08          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x8</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11178</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8b </span><span style=color:#d08770>05 49 51 03 00    </span><span style=color:#b48ead>mov    </span><span style=color:#d08770>0x35149</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rip</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax        </span><span style=color:#8fa1b3># 462c8 &lt;_etext</span><span>+</span><span style=color:#d08770>0x423</span><span style=color:#8fa1b3>>
</span><span style=color:#8fa1b3>   1117f:       </span><span style=color:#d08770>48 89 44 24 10          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x10</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11184</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d </span><span style=color:#d08770>05 </span><span style=color:#8fa1b3>e5 </span><span style=color:#d08770>57 03 00    </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x357e5</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rip</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax        </span><span style=color:#8fa1b3># </span><span style=color:#d08770>46970 </span><span style=color:#8fa1b3>&lt;_DYNAMIC</span><span>+</span><span style=color:#d08770>0x280</span><span style=color:#8fa1b3>>
</span><span style=color:#8fa1b3>   1118b:       </span><span style=color:#d08770>48 89 44 24 18          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x18</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11190</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>c7 </span><span style=color:#d08770>44 24 20 02 00    </span><span style=color:#b48ead>movq   </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x2</span><span>,</span><span style=color:#d08770>0x20</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11197</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>00 00
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11199</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>c7 </span><span style=color:#d08770>44 24 28 00 00    </span><span style=color:#b48ead>movq   </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x0</span><span>,</span><span style=color:#d08770>0x28</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   111a0:       </span><span style=color:#d08770>00 00
</span><span style=color:#8fa1b3>   111a2:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d </span><span style=color:#d08770>44 24 08          </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x8</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax
</span><span style=color:#8fa1b3>   111a7:       </span><span style=color:#d08770>48 89 44 24 38          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x38</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   111ac:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>c7 </span><span style=color:#d08770>44 24 40 01 00    </span><span style=color:#b48ead>movq   </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x1</span><span>,</span><span style=color:#d08770>0x40</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   111b3:       </span><span style=color:#d08770>00 00
</span><span style=color:#8fa1b3>   111b5:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d 7c </span><span style=color:#d08770>24 18          </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x18</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rdi
</span><span style=color:#8fa1b3>   111ba:       ff </span><span style=color:#d08770>15 48 </span><span style=color:#8fa1b3>4f </span><span style=color:#d08770>03 00       </span><span style=color:#b48ead>call   </span><span>*</span><span style=color:#d08770>0x34f48</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rip</span><span style=color:#8fa1b3>)        # </span><span style=color:#d08770>46108 </span><span style=color:#8fa1b3>&lt;_etext</span><span>+</span><span style=color:#d08770>0x263</span><span style=color:#8fa1b3>>
</span><span style=color:#8fa1b3>   111c0:       </span><span style=color:#d08770>48 83 </span><span style=color:#8fa1b3>c4 </span><span style=color:#d08770>48             </span><span style=color:#b48ead>add    </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x48</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rsp
</span><span style=color:#8fa1b3>   111c4:       c3                      </span><span style=color:#b48ead>ret
</span><span style=color:#8fa1b3>        ...
</span><span style=color:#96b5b4>[snip]
</span></code></pre><p>Ookay, assembly is hard to read. What happens without the <code>mut</code>?<pre class=language-asm data-lang=asm style=color:#c0c5ce;background-color:#2b303b><code class=language-asm data-lang=asm><span style=color:#d08770>0000000000011160 </span><span style=color:#8fa1b3>&lt;_ZN11self_modify4main17hd56d204cd8f62812E>:
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11160</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 83 </span><span style=color:#8fa1b3>ec </span><span style=color:#d08770>48             </span><span style=color:#b48ead>sub    </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x48</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rsp
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11164</span><span style=color:#8fa1b3>:       c7 </span><span style=color:#d08770>44 24 04 </span><span style=color:#8fa1b3>aa </span><span style=color:#d08770>55 </span><span style=color:#8fa1b3>aa    movl   </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x55aa55aa</span><span>,</span><span style=color:#d08770>0x4</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   1116b:       </span><span style=color:#d08770>55
</span><span style=color:#8fa1b3>   1116c:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d </span><span style=color:#d08770>44 24 04          </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x4</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11171</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 89 44 24 08          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x8</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11176</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8b </span><span style=color:#d08770>05 </span><span style=color:#8fa1b3>4b </span><span style=color:#d08770>51 03 00    </span><span style=color:#b48ead>mov    </span><span style=color:#d08770>0x3514b</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rip</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax        </span><span style=color:#8fa1b3># 462c8 &lt;_etext</span><span>+</span><span style=color:#d08770>0x423</span><span style=color:#8fa1b3>>
</span><span style=color:#8fa1b3>   1117d:       </span><span style=color:#d08770>48 89 44 24 10          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x10</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11182</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d </span><span style=color:#d08770>05 </span><span style=color:#8fa1b3>e7 </span><span style=color:#d08770>57 03 00    </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x357e7</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rip</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax        </span><span style=color:#8fa1b3># </span><span style=color:#d08770>46970 </span><span style=color:#8fa1b3>&lt;_DYNAMIC</span><span>+</span><span style=color:#d08770>0x280</span><span style=color:#8fa1b3>>
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11189</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 89 44 24 18          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x18</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   1118e:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>c7 </span><span style=color:#d08770>44 24 20 02 00    </span><span style=color:#b48ead>movq   </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x2</span><span>,</span><span style=color:#d08770>0x20</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11195</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>00 00
</span><span style=color:#8fa1b3>   </span><span style=color:#d08770>11197</span><span style=color:#8fa1b3>:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>c7 </span><span style=color:#d08770>44 24 28 00 00    </span><span style=color:#b48ead>movq   </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x0</span><span>,</span><span style=color:#d08770>0x28</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   1119e:       </span><span style=color:#d08770>00 00
</span><span style=color:#8fa1b3>   111a0:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d </span><span style=color:#d08770>44 24 08          </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x8</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax
</span><span style=color:#8fa1b3>   111a5:       </span><span style=color:#d08770>48 89 44 24 38          </span><span style=color:#b48ead>mov    </span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rax</span><span>,</span><span style=color:#d08770>0x38</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   111aa:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>c7 </span><span style=color:#d08770>44 24 40 01 00    </span><span style=color:#b48ead>movq   </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x1</span><span>,</span><span style=color:#d08770>0x40</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)
</span><span style=color:#8fa1b3>   111b1:       </span><span style=color:#d08770>00 00
</span><span style=color:#8fa1b3>   111b3:       </span><span style=color:#d08770>48 </span><span style=color:#8fa1b3>8d 7c </span><span style=color:#d08770>24 18          </span><span style=color:#b48ead>lea    </span><span style=color:#d08770>0x18</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rsp</span><span style=color:#8fa1b3>)</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rdi
</span><span style=color:#8fa1b3>   111b8:       ff </span><span style=color:#d08770>15 </span><span style=color:#8fa1b3>4a 4f </span><span style=color:#d08770>03 00       </span><span style=color:#b48ead>call   </span><span>*</span><span style=color:#d08770>0x34f4a</span><span style=color:#8fa1b3>(%</span><span style=color:#bf616a>rip</span><span style=color:#8fa1b3>)        # </span><span style=color:#d08770>46108 </span><span style=color:#8fa1b3>&lt;_etext</span><span>+</span><span style=color:#d08770>0x263</span><span style=color:#8fa1b3>>
</span><span style=color:#8fa1b3>   111be:       </span><span style=color:#d08770>48 83 </span><span style=color:#8fa1b3>c4 </span><span style=color:#d08770>48             </span><span style=color:#b48ead>add    </span><span style=color:#96b5b4>$</span><span style=color:#d08770>0x48</span><span>,</span><span style=color:#8fa1b3>%</span><span style=color:#bf616a>rsp
</span><span style=color:#8fa1b3>   111c2:       c3                      </span><span style=color:#b48ead>ret
</span><span style=color:#8fa1b3>        ...
</span></code></pre><p>Did you spot the <code>movl   $0x55aa55aa,0x4(%rsp)</code> on the second line? That's our value, inlined in the compiled code.<p>To be honest, we're getting a lot of extra code in there. Instead, it's better to get rid of the <code>println!</code>, simplify the code as much as possible and paste it on godbolt.org. Click <a href=https://godbolt.org/z/d5rbj7fMG>here</a> to see how that looks.</div></div>